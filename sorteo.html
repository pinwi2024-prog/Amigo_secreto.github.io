<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego del Amigo Secreto Seguro</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --light: #ecf0f1;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        h1 { color: var(--primary); margin-bottom: 20px; }
        input, button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover { background-color: #34495e; }
        .btn-danger { background-color: var(--accent); }
        .btn-danger:hover { background-color: #c0392b; }
        
        /* Listas */
        ul { list-style: none; padding: 0; text-align: left; }
        li {
            background: #f9f9f9;
            border-bottom: 1px solid #ddd;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Vistas */
        .hidden { display: none; }
        
        /* Modal y Tarjetas de Usuario */
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        .user-card {
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .user-card:hover { transform: translateY(-3px); }

        .result-box {
            margin-top: 20px;
            padding: 20px;
            background: #dff9fb;
            border: 2px dashed var(--primary);
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-view">
        <h1>ðŸŽ… ConfiguraciÃ³n</h1>
        <p>Agrega a los participantes y una clave numÃ©rica para cada uno.</p>
        
        <div style="display: flex; gap: 5px;">
            <input type="text" id="newName" placeholder="Nombre (ej. Juan)" style="flex: 2;">
            <input type="number" id="newPin" placeholder="PIN (ej. 1234)" style="flex: 1;">
        </div>
        <button onclick="addParticipant()">Agregar Participante</button>

        <ul id="participants-list">
            </ul>

        <div id="action-area" class="hidden">
            <hr>
            <button onclick="startGame()" class="btn-danger">ðŸŽ² Realizar Sorteo y Jugar</button>
        </div>
    </div>

    <div id="game-view" class="hidden">
        <h1>ðŸŽ„ Â¿QuiÃ©n eres?</h1>
        <p>Selecciona tu nombre para ver tu amigo secreto.</p>
        <div class="user-grid" id="user-grid">
            </div>
        <br>
        <button onclick="resetApp()" style="background:#95a5a6; font-size: 0.8rem;">Reiniciar Todo</button>
    </div>

    <div id="reveal-view" class="hidden">
        <h2 id="reveal-title">Hola...</h2>
        <p>Ingresa tu clave de seguridad para ver el resultado:</p>
        <input type="number" id="authPin" placeholder="Tu PIN secreto">
        <button onclick="checkPin()">Ver Resultado</button>
        <button onclick="backToGame()" style="background: transparent; color: #7f8c8d; border: 1px solid #ccc;">Cancelar</button>

        <div id="secret-result" class="hidden">
            <p>Tu amigo secreto es:</p>
            <div class="result-box" id="result-name">NOMBRE</div>
            <p style="font-size: 0.8rem; color: #e74c3c;">Â¡MemorÃ­zalo! Este mensaje se autodestruirÃ¡ al cerrar.</p>
            <button onclick="backToGame()">ðŸ”’ Cerrar y Proteger</button>
        </div>
    </div>
</div>

<script>
    // Estado de la aplicaciÃ³n
    let participants = []; // {id, name, pin, matchId}
    let selectedUser = null;

    // Agregar Participante
    function addParticipant() {
        const nameInput = document.getElementById('newName');
        const pinInput = document.getElementById('newPin');
        const name = nameInput.value.trim();
        const pin = pinInput.value.trim();

        if (!name || !pin) {
            alert("Por favor ingresa nombre y PIN.");
            return;
        }

        // Verificar duplicados de nombre
        if (participants.some(p => p.name.toLowerCase() === name.toLowerCase())) {
            alert("Ese nombre ya existe.");
            return;
        }

        participants.push({
            id: Date.now() + Math.random(), // ID Ãºnico
            name: name,
            pin: pin,
            matchId: null
        });

        nameInput.value = '';
        pinInput.value = '';
        nameInput.focus();
        renderList();
    }

    // Renderizar lista de configuraciÃ³n
    function renderList() {
        const list = document.getElementById('participants-list');
        list.innerHTML = '';
        participants.forEach((p, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span><b>${p.name}</b> (PIN: ****)</span>
                <button style="width: auto; padding: 5px 10px; background: #e74c3c;" onclick="removeParticipant(${index})">X</button>
            `;
            list.appendChild(li);
        });

        const actionArea = document.getElementById('action-area');
        if (participants.length >= 3) {
            actionArea.classList.remove('hidden');
        } else {
            actionArea.classList.add('hidden');
        }
    }

    function removeParticipant(index) {
        participants.splice(index, 1);
        renderList();
    }

    // LÃ³gica del Sorteo (Algoritmo Fisher-Yates con validaciÃ³n)
    function startGame() {
        if (participants.length < 3) {
            alert("Se necesitan al menos 3 participantes.");
            return;
        }

        let valid = false;
        let pool = [];

        // Intentar barajar hasta que nadie se tenga a sÃ­ mismo
        // (Para listas pequeÃ±as es instantÃ¡neo)
        while (!valid) {
            // Crear pool de IDs para regalar
            pool = participants.map(p => p.id);
            
            // Barajar (Shuffle)
            for (let i = pool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }

            // Validar que nadie coincida consigo mismo
            valid = true;
            for (let i = 0; i < participants.length; i++) {
                if (participants[i].id === pool[i]) {
                    valid = false;
                    break;
                }
            }
        }

        // Asignar los resultados
        for (let i = 0; i < participants.length; i++) {
            participants[i].matchId = pool[i];
        }

        // Cambiar vista
        document.getElementById('setup-view').classList.add('hidden');
        document.getElementById('game-view').classList.remove('hidden');
        renderGameGrid();
    }

    // Renderizar tarjetas de juego
    function renderGameGrid() {
        const grid = document.getElementById('user-grid');
        grid.innerHTML = '';
        participants.forEach(p => {
            const card = document.createElement('div');
            card.className = 'user-card';
            card.innerText = p.name;
            card.onclick = () => selectUser(p);
            grid.appendChild(card);
        });
    }

    // Seleccionar usuario para revelar
    function selectUser(user) {
        selectedUser = user;
        document.getElementById('game-view').classList.add('hidden');
        document.getElementById('reveal-view').classList.remove('hidden');
        document.getElementById('reveal-title').innerText = `Hola, ${user.name}`;
        document.getElementById('authPin').value = '';
        document.getElementById('secret-result').classList.add('hidden');
    }

    // Verificar PIN y mostrar resultado
    function checkPin() {
        const inputPin = document.getElementById('authPin').value;
        if (inputPin === selectedUser.pin) {
            const match = participants.find(p => p.id === selectedUser.matchId);
            document.getElementById('result-name').innerText = match.name;
            document.getElementById('secret-result').classList.remove('hidden');
        } else {
            alert("PIN Incorrecto. IntÃ©ntalo de nuevo.");
            document.getElementById('authPin').value = '';
        }
    }

    // Volver a la pantalla de selecciÃ³n
    function backToGame() {
        selectedUser = null;
        document.getElementById('reveal-view').classList.add('hidden');
        document.getElementById('game-view').classList.remove('hidden');
    }

    function resetApp() {
        if(confirm("Â¿EstÃ¡s seguro de reiniciar? Se perderÃ¡n los sorteos.")) {
            location.reload();
        }
    }
</script>

</body>
</html>